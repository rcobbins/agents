#!/bin/bash

# Agent Framework CLI
# Main command-line interface for the Agent Framework

set -e

# Script directory and paths
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Determine framework directory
# If we're in ~/.local/bin, use the actual framework location
if [[ "$SCRIPT_DIR" == "$HOME/.local/bin" ]]; then
    FRAMEWORK_DIR="/home/rob/agent-framework"
else
    FRAMEWORK_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
fi

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Version
VERSION="1.0.0"

# Show usage
show_usage() {
    echo "Agent Framework v$VERSION"
    echo ""
    echo "Usage: agent-framework <command> [options]"
    echo ""
    echo "Commands:"
    echo "  init <path>        Initialize a new project with the setup wizard"
    echo "  init-demo <path>   Initialize a demo project with TaskFlow app"
    echo "  launch <path>      Launch agents for a project"
    echo "  validate <path>    Validate project setup"
    echo "  stop <path>        Stop all agents for a project"
    echo "  monitor <path>     Monitor running agents"
    echo "  web                Start the web UI server"
    echo "  version            Show version information"
    echo "  help               Show this help message"
    echo ""
    echo "Examples:"
    echo "  agent-framework init /path/to/project"
    echo "  agent-framework launch /path/to/project"
    echo "  agent-framework web"
}

# Parse command
COMMAND="${1:-help}"
shift || true

case "$COMMAND" in
    init)
        # Run initialization wizard
        PROJECT_PATH="${1:-$(pwd)}"
        echo -e "${BLUE}Initializing project at: $PROJECT_PATH${NC}"
        exec "$FRAMEWORK_DIR/init/wizard.sh" "$PROJECT_PATH"
        ;;
        
    init-demo)
        # Initialize demo project with pre-populated templates
        PROJECT_PATH="${1:-$(pwd)}"
        echo -e "${BLUE}Initializing demo project at: $PROJECT_PATH${NC}"
        exec "$FRAMEWORK_DIR/demo/init-demo.sh" "$PROJECT_PATH"
        ;;
        
    launch)
        # Launch agents
        PROJECT_PATH="${1:-$(pwd)}"
        exec "$FRAMEWORK_DIR/launcher/cli/launch.sh" "$PROJECT_PATH"
        ;;
        
    validate)
        # Validate project
        PROJECT_PATH="${1:-$(pwd)}"
        exec "$FRAMEWORK_DIR/init/validators/check-readiness.sh" "$PROJECT_PATH"
        ;;
        
    stop)
        # Stop agents
        PROJECT_PATH="${1:-$(pwd)}"
        echo -e "${YELLOW}Stopping agents for: $PROJECT_PATH${NC}"
        # Find and kill agent processes
        pkill -f "agent.*$PROJECT_PATH" || true
        echo -e "${GREEN}Agents stopped${NC}"
        ;;
        
    monitor)
        # Monitor agents
        PROJECT_PATH="${1:-$(pwd)}"
        echo -e "${BLUE}Monitoring agents for: $PROJECT_PATH${NC}"
        # Tail agent logs
        AGENT_DIR="$PROJECT_PATH/.agents"
        if [ -d "$AGENT_DIR/logs" ]; then
            tail -f "$AGENT_DIR/logs"/*.log 2>/dev/null
        else
            echo -e "${RED}No agent logs found${NC}"
        fi
        ;;
        
    web)
        # Start web UI (both frontend and backend)
        echo -e "${BLUE}Starting Agent Framework Web UI...${NC}"
        echo -e "${CYAN}Frontend: http://localhost:3000${NC}"
        echo -e "${CYAN}Backend API: http://localhost:3001${NC}"
        echo ""
        
        # Check and install server dependencies
        if [ ! -d "$FRAMEWORK_DIR/web-ui/server/node_modules" ]; then
            echo -e "${YELLOW}Installing server dependencies...${NC}"
            cd "$FRAMEWORK_DIR/web-ui/server"
            npm install
        fi
        
        # Check and install client dependencies
        if [ ! -d "$FRAMEWORK_DIR/web-ui/client/node_modules" ]; then
            echo -e "${YELLOW}Installing client dependencies...${NC}"
            cd "$FRAMEWORK_DIR/web-ui/client"
            npm install
        fi
        
        # Check and install main dependencies (for concurrently)
        cd "$FRAMEWORK_DIR"
        if [ ! -d "node_modules" ]; then
            echo -e "${YELLOW}Installing main dependencies...${NC}"
            npm install
        fi
        
        # Check if concurrently is available
        if npm list concurrently >/dev/null 2>&1; then
            echo -e "${GREEN}Starting both services with concurrently...${NC}"
            npm run dev
        else
            echo -e "${YELLOW}Starting services separately (concurrently not found)...${NC}"
            echo -e "${CYAN}Starting backend server on port 3001...${NC}"
            cd "$FRAMEWORK_DIR/web-ui/server"
            npm start &
            SERVER_PID=$!
            
            echo -e "${CYAN}Starting frontend on port 3000...${NC}"
            cd "$FRAMEWORK_DIR/web-ui/client"
            npm run dev
            
            # When frontend is stopped, also stop backend
            kill $SERVER_PID 2>/dev/null
        fi
        ;;
        
    version|--version|-v)
        echo "Agent Framework v$VERSION"
        ;;
        
    help|--help|-h)
        show_usage
        ;;
        
    *)
        echo -e "${RED}Unknown command: $COMMAND${NC}"
        echo ""
        show_usage
        exit 1
        ;;
esac